- 1.控制器的产生
控制器本身也是一个broker，负责分区首领的选举。集群中第一个启动的broker通过zookeeper创建一个临时节点/controller让自己成为控制器。其他broker启动时也会去尝试创建这个节点，在收到“节点已存在”的异常后，创建Zookeeper Watch对象接收zookeeper节点的变更通知，确保集群只有一个控制器存在。
如果控制器被关闭或者与zookeeper断开连接，那么zookeeper上的临时节点就会消失。集群里的其他broker会收到控制器节点消失的通知，它们会主动尝试让自己成为控制器，第一个在zookeeper成功创建控制器节点的broker就会成为新的控制器。
- 2.复制
首领副本，每个分区都有一个首领副本，所有的生产者请求和消费请求都会经过这里。跟随者副本，除开首领副本意外的副本都是跟随者副本，它唯一的任务就是从首领那里复制消息，保持和首领一直的状态。并随时准备在首领崩溃时，替换成新首领。持续请求得到最新消息的副本称为同步的副本，在首领失效时，只有同步的副本才能有可能被选为新首领。
首选首领，创建主题时选定的首领就是分区的首选首领，之所以叫做首选首领，是因为在创建分区时，需要在borker之间均衡首领。
- 3.ISR
partition首领会维护一个与其基本同步的副本列表，每个partition都会有一个ISR，而且是首领动态维护。如果一个跟随者比一个首领落后太多或者超过一定时间未发起数据复制请求，则首领将其从ISR中移除。当选择ack=all时，只有ISR中的所有分区副本都向首领发送ack时，首领才会提交对请求消息的确认。

